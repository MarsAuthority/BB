import{ad as p,H as e,I as o,F as n,U as a,O as t,ae as c,X as l}from"./framework-d186cff1.js";const i={},u=c(`<h2 id="内存管理概述" tabindex="-1"><a class="header-anchor" href="#内存管理概述" aria-hidden="true">#</a> 内存管理概述</h2><p>内存管理，是指软件运行时对计算机内存资源的分配和使用的技术。其最主要的目的是如何高效，快速的分配，并且在适当的时候释放和回收内存资源。</p><p>在使用C/C++开发程序的时候，需要格外注意内存管理，申请了内存再使用完后要记得释放，否则可能会造成内存泄漏。如果程序需要常驻内存，那么内存泄漏问题会把机器的内存耗光。所以在PHP这种需要常驻内存的程序来说，内存管理非常重要，它决定了程序的稳定性和执行效率。另外，应用程序向系统申请内存，释放内存的时候会引发系统调用，系统调用提供用户程序与操作系统之间的接口，他会触发0x80 号中断（int 0x80）将CPU从用户态切换到内核态，执行完毕再切换回用户态。在PHP这种对性能要求较高的程序来说，频繁在用户态和内核态切换会带来很大的性能消耗。</p><p>介于以上原因，PHP实现了自己的内存管理器（ZendMM）, 所以在编写PHP脚本的时候我们不需要对内存进行管理。</p><h2 id="zendmm" tabindex="-1"><a class="header-anchor" href="#zendmm" aria-hidden="true">#</a> ZendMM</h2><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>Zend Memory Manager
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

General<span class="token operator">:</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>

The goal of the new memory <span class="token function">manager</span> <span class="token punctuation">(</span>available since PHP <span class="token number">5.2</span><span class="token punctuation">)</span> is to reduce memory
allocation overhead and speedup memory management<span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>PHP的内存管理是分层的，它分为三层：存储层（storage）、堆层（heap）和接口层（emalloc/efree）。存储层通过 malloc()、mmap() 等函数向系统真正的申请内存，并通过 free() 函数释放所申请的内存。存储层通常一次申请大量内存，这样接口层在需要分配空间的时候，通过堆层将存储层申请到的内存进行拆分，按照大小给接口层使用。在存储层共有4种内存分配方案: malloc，win32，mmap_anon，mmap_zero。默认使用malloc分配内存，如果设置了ZEND_WIN32宏，则为windows版本，调用HeapAlloc分配内存。并且PHP的内存方案可以通过设置变量来修改。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>the Zend MM can be tweaked using ZEND_MM_MEM_TYPE and ZEND_MM_SEG_SIZE environment
variables<span class="token punctuation">.</span>  Default values are <span class="token string">&quot;malloc&quot;</span> and <span class="token string">&quot;256K&quot;</span><span class="token punctuation">.</span> Dependent on target system you
can also use <span class="token string">&quot;mmap_anon&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mmap_zero&quot;</span> and <span class="token string">&quot;win32&quot;</span> storage managers<span class="token punctuation">.</span>

	$ ZEND_MM_MEM_TYPE<span class="token operator">=</span>mmap_anon ZEND_MM_SEG_SIZE<span class="token operator">=</span><span class="token number">1</span>M sapi<span class="token operator">/</span>cli<span class="token operator">/</span>php <span class="token punctuation">.</span><span class="token punctuation">.</span>etc<span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>借用一张图来说明一下：</p><figure><img src="https://cdn.jsdelivr.net/gh/MarsAuthority/sec_pic@master/uPic/2023-02/4PFj1W.jpg" alt="4PFj1W" tabindex="0" loading="lazy"><figcaption>4PFj1W</figcaption></figure><p>内存分配有两种类型：</p><ol><li>small, 为了速度和效率。</li><li>large, 为了不造成浪费。</li></ol><p>内存分配有两种生命周期：</p><ol><li>request，最常见的情况，只需要满足当前请求的内存需求，一次请求结束之后就free。</li><li>persistent，需要被分配比单个请求持续时间更长的一段时间的内存，这种情况下使用操作系统的malloc来分配内存，这些分配的内存并不会添加ZendMM使用的那些额外的信息，从而实现永久分配。</li></ol><p>ZendMM提供的request内存分配相关函数：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">void</span><span class="token operator">*</span>  <span class="token function">emalloc</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span><span class="token operator">*</span>  <span class="token function">erealloc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> pointer<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span><span class="token operator">*</span>  <span class="token function">ecalloc</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> num<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span>   <span class="token function">efree</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> pointer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ZendMM提供的persistent内存分配相关函数：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">pemalloc</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> size<span class="token punctuation">,</span> zend_bool persistent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">perealloc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> pointer<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> zend_bool persistent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">pecalloc</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> num<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> zend_bool persistent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span>  <span class="token function">pefree</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> pointer<span class="token punctuation">,</span> zend_bool persistent<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="存储层-storage" tabindex="-1"><a class="header-anchor" href="#存储层-storage" aria-hidden="true">#</a> 存储层（storage）</h2><p>存储层（storage）是向系统真正的申请内存，它的作用是将内存分配的方式对堆层透明化。我们先看看它的结构。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">/* Heaps with user defined storage */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_zend_mm_storage</span> zend_mm_storage<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_zend_mm_segment</span> <span class="token punctuation">{</span>
	<span class="token class-name">size_t</span>	size<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">_zend_mm_segment</span> <span class="token operator">*</span>next_segment<span class="token punctuation">;</span>
<span class="token punctuation">}</span> zend_mm_segment<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_zend_mm_mem_handlers</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
	zend_mm_storage<span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>init<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>dtor<span class="token punctuation">)</span><span class="token punctuation">(</span>zend_mm_storage <span class="token operator">*</span>storage<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>compact<span class="token punctuation">)</span><span class="token punctuation">(</span>zend_mm_storage <span class="token operator">*</span>storage<span class="token punctuation">)</span><span class="token punctuation">;</span>
	zend_mm_segment<span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>_alloc<span class="token punctuation">)</span><span class="token punctuation">(</span>zend_mm_storage <span class="token operator">*</span>storage<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	zend_mm_segment<span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>_realloc<span class="token punctuation">)</span><span class="token punctuation">(</span>zend_mm_storage <span class="token operator">*</span>storage<span class="token punctuation">,</span> zend_mm_segment <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>_free<span class="token punctuation">)</span><span class="token punctuation">(</span>zend_mm_storage <span class="token operator">*</span>storage<span class="token punctuation">,</span> zend_mm_segment <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> zend_mm_mem_handlers<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">_zend_mm_storage</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> zend_mm_mem_handlers <span class="token operator">*</span>handlers<span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们看看存储层（storage）的初始化函数zend_mm_startup():</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>ZEND_API zend_mm_heap <span class="token operator">*</span><span class="token function">zend_mm_startup</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>
	<span class="token class-name">size_t</span> seg_size<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>mem_type <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">&quot;ZEND_MM_MEM_TYPE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//内存分配方案</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>tmp<span class="token punctuation">;</span>
	<span class="token keyword">const</span> zend_mm_mem_handlers <span class="token operator">*</span>handlers<span class="token punctuation">;</span>
	zend_mm_heap <span class="token operator">*</span>heap<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>mem_type <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//默认使用malloc为分配方案，也就是0</span>
		i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> mem_handlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>mem_handlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> mem_type<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mem_handlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;Wrong or unsupported zend_mm storage type &#39;%s&#39;\\n&quot;</span><span class="token punctuation">,</span> mem_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;  supported types:\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* See http://support.microsoft.com/kb/190351 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">PHP_WIN32</span></span>
			<span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> mem_handlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;    &#39;%s&#39;\\n&quot;</span><span class="token punctuation">,</span> mem_handlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
<span class="token comment">/* See http://support.microsoft.com/kb/190351 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">PHP_WIN32</span></span>
			<span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
			<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	handlers <span class="token operator">=</span> <span class="token operator">&amp;</span>mem_handlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token comment">//使用相应内存分配方案的handler，mem_handlers是结构体zend_mm_mem_handlers</span>

	tmp <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">&quot;ZEND_MM_SEG_SIZE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token keyword">if</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		seg_size <span class="token operator">=</span> <span class="token function">zend_atoi</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">zend_mm_low_bit</span><span class="token punctuation">(</span>seg_size<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">zend_mm_high_bit</span><span class="token punctuation">(</span>seg_size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;ZEND_MM_SEG_SIZE must be a power of two\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* See http://support.microsoft.com/kb/190351 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">PHP_WIN32</span></span>
			<span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
			<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>seg_size <span class="token operator">&lt;</span> ZEND_MM_ALIGNED_SEGMENT_SIZE <span class="token operator">+</span> ZEND_MM_ALIGNED_HEADER_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;ZEND_MM_SEG_SIZE is too small\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* See http://support.microsoft.com/kb/190351 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">PHP_WIN32</span></span>
			<span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
			<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		seg_size <span class="token operator">=</span> ZEND_MM_SEG_SIZE<span class="token punctuation">;</span> <span class="token comment">//段分配大小，未指定的话默认为ZEND_MM_SEG_SIZE，即(256 * 1024)</span>
	<span class="token punctuation">}</span>

	heap <span class="token operator">=</span> <span class="token function">zend_mm_startup_ex</span><span class="token punctuation">(</span>handlers<span class="token punctuation">,</span> seg_size<span class="token punctuation">,</span> ZEND_MM_RESERVE_SIZE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//初始化heap</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>heap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		tmp <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">&quot;ZEND_MM_COMPACT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token keyword">if</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			heap<span class="token operator">-&gt;</span>compact_size <span class="token operator">=</span> <span class="token function">zend_atoi</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			heap<span class="token operator">-&gt;</span>compact_size <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> heap<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中mem_handlers里面是4种内存分配方案：</p><figure><img src="https://cdn.jsdelivr.net/gh/MarsAuthority/sec_pic@master/uPic/2023-02/4r26LI.jpg" alt="4r26LI" tabindex="0" loading="lazy"><figcaption>4r26LI</figcaption></figure><h2 id="堆层-heap" tabindex="-1"><a class="header-anchor" href="#堆层-heap" aria-hidden="true">#</a> 堆层（heap）</h2><p>我们先看看heap的结构：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">_zend_mm_heap</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span>                 use_zend_alloc<span class="token punctuation">;</span>
    <span class="token keyword">void</span>               <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>_malloc<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span>                <span class="token punctuation">(</span><span class="token operator">*</span>_free<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span>               <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>_realloc<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">size_t</span>              free_bitmap<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span>              large_free_bitmap<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span>              block_size<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span>              compact_size<span class="token punctuation">;</span>
    zend_mm_segment    <span class="token operator">*</span>segments_list<span class="token punctuation">;</span>
    zend_mm_storage    <span class="token operator">*</span>storage<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span>              real_size<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span>              real_peak<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span>              limit<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span>              size<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span>              peak<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span>              reserve_size<span class="token punctuation">;</span>
    <span class="token keyword">void</span>               <span class="token operator">*</span>reserve<span class="token punctuation">;</span>
    <span class="token keyword">int</span>                 overflow<span class="token punctuation">;</span>
    <span class="token keyword">int</span>                 internal<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ZEND_MM_CACHE</span></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>        cached<span class="token punctuation">;</span>
    zend_mm_free_block <span class="token operator">*</span>cache<span class="token punctuation">[</span>ZEND_MM_NUM_BUCKETS<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    zend_mm_free_block <span class="token operator">*</span>free_buckets<span class="token punctuation">[</span>ZEND_MM_NUM_BUCKETS<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    zend_mm_free_block <span class="token operator">*</span>large_free_buckets<span class="token punctuation">[</span>ZEND_MM_NUM_BUCKETS<span class="token punctuation">]</span><span class="token punctuation">;</span>
    zend_mm_free_block <span class="token operator">*</span>rest_buckets<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span>                 rest_count<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ZEND_MM_CACHE_STAT</span></span>
    <span class="token keyword">struct</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> count<span class="token punctuation">;</span>
        <span class="token keyword">int</span> max_count<span class="token punctuation">;</span>
        <span class="token keyword">int</span> hit<span class="token punctuation">;</span>
        <span class="token keyword">int</span> miss<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> cache_stat<span class="token punctuation">[</span>ZEND_MM_NUM_BUCKETS<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中free_buckets 和 large_free_buckets 是关键，它们分别是小块内存列表和大块内存列表，在接口层申请内存的时候，ZendMM会在heap层中搜索合适大小的内存块，small类型的使用free_buckets，large类型则使用large_free_buckets，如果都没有足够的内存的话，就使用rest_buckets。经过以上步骤还没有合适的资源的话，使用ZEND_MM_STORAGE_ALLOC函数向系统再申请一块内存。</p><p>之前的zend_mm_startup()函数调用zend_mm_startup_ex()来初始化堆层（heap），这里我们只说一下其中的zend_mm_init()，我们看看它的实现：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">zend_mm_init</span><span class="token punctuation">(</span>zend_mm_heap <span class="token operator">*</span>heap<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	zend_mm_free_block<span class="token operator">*</span> p<span class="token punctuation">;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>

	heap<span class="token operator">-&gt;</span>free_bitmap <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//小块空闲内存标识</span>
	heap<span class="token operator">-&gt;</span>large_free_bitmap <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//大块空闲内存标识</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ZEND_MM_CACHE</span></span>
	heap<span class="token operator">-&gt;</span>cached <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>heap<span class="token operator">-&gt;</span>cache<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>heap<span class="token operator">-&gt;</span>cache<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ZEND_MM_CACHE_STAT</span></span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ZEND_MM_NUM_BUCKETS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		heap<span class="token operator">-&gt;</span>cache_stat<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	p <span class="token operator">=</span> <span class="token function">ZEND_MM_SMALL_FREE_BUCKET</span><span class="token punctuation">(</span>heap<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ZEND_MM_NUM_BUCKETS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		p<span class="token operator">-&gt;</span>next_free_block <span class="token operator">=</span> p<span class="token punctuation">;</span>
		p<span class="token operator">-&gt;</span>prev_free_block <span class="token operator">=</span> p<span class="token punctuation">;</span>
		p <span class="token operator">=</span> <span class="token punctuation">(</span>zend_mm_free_block<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>p <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>zend_mm_free_block<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		heap<span class="token operator">-&gt;</span>large_free_buckets<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	heap<span class="token operator">-&gt;</span>rest_buckets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> heap<span class="token operator">-&gt;</span>rest_buckets<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ZEND_MM_REST_BUCKET</span><span class="token punctuation">(</span>heap<span class="token punctuation">)</span><span class="token punctuation">;</span>
	heap<span class="token operator">-&gt;</span>rest_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们先看看鸟哥画的Heap结构图：</p><figure><img src="https://cdn.jsdelivr.net/gh/MarsAuthority/sec_pic@master/uPic/2023-02/TJ6pEQ.jpg" alt="TJ6pEQ" tabindex="0" loading="lazy"><figcaption>TJ6pEQ</figcaption></figure><p>再回到zend_mm_init()，这里同时初始化free_buckets 和 large_free_buckets。其实他们就像Hashtable一样，每个bucket也对应一定大小的内存块列表。</p><p>free_buckets使用宏<code>ZEND_MM_SMALL_FREE_BUCKET</code>来管理分配小块内存：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ZEND_MM_SMALL_FREE_BUCKET</span><span class="token expression"><span class="token punctuation">(</span>heap<span class="token punctuation">,</span> index<span class="token punctuation">)</span> </span><span class="token punctuation">\\</span>
	<span class="token expression"><span class="token punctuation">(</span>zend_mm_free_block<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>heap<span class="token operator">-&gt;</span>free_buckets<span class="token punctuation">[</span>index <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> </span><span class="token punctuation">\\</span>
		<span class="token expression"><span class="token keyword">sizeof</span><span class="token punctuation">(</span>zend_mm_free_block<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> </span><span class="token punctuation">\\</span>
		<span class="token expression"><span class="token keyword">sizeof</span><span class="token punctuation">(</span>zend_mm_small_free_block<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>free_buckets是一个数组指针，它存储的是指向zend_mm_free_block结构体的指针，他们以两个为一对，分别存储双向链表的头尾指针。如图：</p><figure><img src="https://cdn.jsdelivr.net/gh/MarsAuthority/sec_pic@master/uPic/2023-02/DDTZ3s.jpg" alt="DDTZ3s" tabindex="0" loading="lazy"><figcaption>DDTZ3s</figcaption></figure><p>这里的初始化非常巧妙，我们先看看<code>ZEND_MM_SMALL_FREE_BUCKET</code>，它是将free_buckets列表的偶数位的内存地址(也就是指向prev_free_block的地址)加上两个指针的内存大小并减去zend_mm_small_free_block结构所占空间的大小。而因为zend_mm_free_block结构和zend_mm_small_free_block结构的差距在于两个指针，所以他的计算结果就是free_buckets列表index对应双向链表的第一个zend_mm_free_block的prev_free_block地址减8的地址。为什么是减8的地址？因为zend_mm_free_block的前8个字节是zend_mm_block_info，之后才是prev_free_block。两个结构体如下：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_zend_mm_small_free_block</span> <span class="token punctuation">{</span>
	zend_mm_block_info info<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ZEND_DEBUG</span></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> magic<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">ifdef</span> <span class="token expression">ZTS</span></span>
	THREAD_T thread_id<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token keyword">struct</span> <span class="token class-name">_zend_mm_free_block</span> <span class="token operator">*</span>prev_free_block<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">_zend_mm_free_block</span> <span class="token operator">*</span>next_free_block<span class="token punctuation">;</span>
<span class="token punctuation">}</span> zend_mm_small_free_block<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_zend_mm_free_block</span> <span class="token punctuation">{</span>
	zend_mm_block_info info<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ZEND_DEBUG</span></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> magic<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">ifdef</span> <span class="token expression">ZTS</span></span>
	THREAD_T thread_id<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token keyword">struct</span> <span class="token class-name">_zend_mm_free_block</span> <span class="token operator">*</span>prev_free_block<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">_zend_mm_free_block</span> <span class="token operator">*</span>next_free_block<span class="token punctuation">;</span>  
 
	<span class="token keyword">struct</span> <span class="token class-name">_zend_mm_free_block</span> <span class="token operator">*</span><span class="token operator">*</span>parent<span class="token punctuation">;</span>         
	<span class="token keyword">struct</span> <span class="token class-name">_zend_mm_free_block</span> <span class="token operator">*</span>child<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>         
<span class="token punctuation">}</span> zend_mm_free_block<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为了方面理解，看下图。我们假设index为0的情况，&amp;heap-&gt;free_buckets[0] 的地址为0x881260，加上sizeof(zend_mm_free_block*)* 2 再减去sizeof(zend_mm_small_free_block))的结果 0x881258，它是&amp;heap-&gt;free_buckets[0]地址减8的地址，它指向的结构体 zend_mm_free_block，所以p-&gt;prev_free_block指向的就是0x881260，也就是heap-&gt;free_buckets[0]。</p><figure><img src="https://cdn.jsdelivr.net/gh/MarsAuthority/sec_pic@master/uPic/2023-02/b87C4t.jpg" alt="b87C4t" tabindex="0" loading="lazy"><figcaption>b87C4t</figcaption></figure><p>接着后面的代码：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>p <span class="token operator">=</span> <span class="token function">ZEND_MM_SMALL_FREE_BUCKET</span><span class="token punctuation">(</span>heap<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ZEND_MM_NUM_BUCKETS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    p<span class="token operator">-&gt;</span>next_free_block <span class="token operator">=</span> p<span class="token punctuation">;</span>
    p<span class="token operator">-&gt;</span>prev_free_block <span class="token operator">=</span> p<span class="token punctuation">;</span>
    p <span class="token operator">=</span> <span class="token punctuation">(</span>zend_mm_free_block<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>p <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>zend_mm_free_block<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    heap<span class="token operator">-&gt;</span>large_free_buckets<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在这个循环中，free_buckets的偶数位index，将其next_free_block和prev_free_block都指向自己，通过两个指针的大小(sizeof(zend_mm_free_block*)* 2)实现数组元素的向后移动，index 0-&gt;2-&gt;4-&gt;……-&gt;62 。这种不存储zend_mm_free_block数组，仅存储其指针的方式不可不说精妙。虽然在理解上有一些困难，但是节省了内存。鸟哥是这样说的：</p><blockquote><p>this is a tricky way to store ZEND_MM_NUMER_BUCKET into a fixed length array. and only the prev_free_block and next_free_block will be use in that way, looking at the picture above, the red box. so actually there is same ZEND_MM_NUMBER_BUCKET buckets stored in the free_buckets array.</p></blockquote><p>所以上一张图所示的free_buckets，在经过初始化后，内容为：</p><figure><img src="https://cdn.jsdelivr.net/gh/MarsAuthority/sec_pic@master/uPic/2023-02/qgXzU4.jpg" alt="qgXzU4" tabindex="0" loading="lazy"><figcaption>qgXzU4</figcaption></figure><h1 id="接口层-emalloc-efree" tabindex="-1"><a class="header-anchor" href="#接口层-emalloc-efree" aria-hidden="true">#</a> <strong><strong>接口层（emalloc/efree）</strong></strong></h1><p>PHP实现了emalloc、efree等函数，当程序需要内存的时候，ZendMM会在内存池中分配相应的内存，这样避免了PHP向系统频繁的内存申请操作，节省了系统开销。</p><p>ZendMM在分配内存主要是有以下步骤：</p><p><strong>1：</strong> 计算出ture_size，即内存对齐。如果所需要的内存的大小的低三位不为0（不能为8整除），则将低三位加上7，并与~7进行按位与操作，即对于大小不是8的整数倍的内存大小补全到可以被8整除。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ZEND_MM_TRUE_SIZE</span><span class="token expression"><span class="token punctuation">(</span>size<span class="token punctuation">)</span>             <span class="token punctuation">(</span><span class="token punctuation">(</span>size<span class="token operator">&lt;</span>ZEND_MM_MIN_SIZE<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">(</span>ZEND_MM_ALIGNED_MIN_HEADER_SIZE<span class="token punctuation">)</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token function">ZEND_MM_ALIGNED_SIZE</span><span class="token punctuation">(</span>size<span class="token operator">+</span>ZEND_MM_ALIGNED_HEADER_SIZE<span class="token operator">+</span>END_MAGIC_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>2：</strong> 通过<code>ZEND_MM_MAX_SMALL_SIZE</code>判断出内存大小类型是small还是large，如果是small，则跳到3，large跳到6。(之前也有写到，小于272Byte的内存为小块内存)</p><p><strong>3：</strong> 计算出要申请的内存大小对应的index。</p><p>它的相关函数(即需要分配的内存大小对应的index)为：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ZEND_MM_BUCKET_INDEX</span><span class="token expression"><span class="token punctuation">(</span>true_size<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>true_size<span class="token operator">&gt;&gt;</span>ZEND_MM_ALIGNMENT_LOG2<span class="token punctuation">)</span><span class="token operator">-</span><span class="token punctuation">(</span>ZEND_MM_ALIGNED_MIN_HEADER_SIZE<span class="token operator">&gt;&gt;</span>ZEND_MM_ALIGNMENT_LOG2<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在默认情况下，ZEND_MM_ALIGNMENT = 8，ZEND_MM_ALIGNMENT_LOG2 = 3，ZEND_MM_ALIGNED_MIN_HEADER_SIZE = 16。通过这个宏可以知道，内存大小与index的关系是：</p><table><thead><tr><th>内存大小</th><th>index</th></tr></thead><tbody><tr><td>1 - 23</td><td>0</td></tr><tr><td>24 - 31</td><td>1</td></tr><tr><td>32 - 39</td><td>2</td></tr><tr><td>…</td><td>…</td></tr><tr><td>264 - 271</td><td>31</td></tr></tbody></table><p>所以，小于272Byte的内存为小块内存。如果大于271Byte的话，则index为32，会使free_buckets数组越界。这样，ZendMM就可以快速定位到最可能适合的区域来查找，提高性能。就像哈希函数一样。</p><p><strong>4：</strong> 如果Cache存在的话，即heap→cache[index]存在，则使用这片cache。（CACHE默认开启）</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>best_fit <span class="token operator">=</span> heap<span class="token operator">-&gt;</span>cache<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>**5：**如果未找到Cache，则从free_buckets查找是否存在空闲内存。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>bitmap <span class="token operator">=</span> heap<span class="token operator">-&gt;</span>free_bitmap <span class="token operator">&gt;&gt;</span> index<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>bitmap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">/* Found some &quot;small&quot; free block that can be used */</span>
			index <span class="token operator">+=</span> <span class="token function">zend_mm_low_bit</span><span class="token punctuation">(</span>bitmap<span class="token punctuation">)</span><span class="token punctuation">;</span>
			best_fit <span class="token operator">=</span> heap<span class="token operator">-&gt;</span>free_buckets<span class="token punctuation">[</span>index<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ZEND_MM_CACHE_STAT</span></span>
			heap<span class="token operator">-&gt;</span>cache_stat<span class="token punctuation">[</span>ZEND_MM_NUM_BUCKETS<span class="token punctuation">]</span><span class="token punctuation">.</span>hit<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
			<span class="token keyword">goto</span> zend_mm_finished_searching_for_block<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>**5.1：**首先看看free_buckets中剩余的内存是否满足true_size。（将heap-&gt;free_bitmap 右移index次，不为0则有空闲内存）</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>bitmap <span class="token operator">=</span> heap<span class="token operator">-&gt;</span>free_bitmap <span class="token operator">&gt;&gt;</span> index<span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>bitmap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>**5.2：**根据内存大小找到最小块内存。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>index <span class="token operator">+=</span> <span class="token function">zend_mm_low_bit</span><span class="token punctuation">(</span>bitmap<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这里说一下zend_mm_low_bit和zend_mm_high_bit。他们就像哈希函数一样，将不同大小的内存映射到不同的index，使ZendMM快速定位，提高性能。</p><p>zend_mm_low_bit实现如下：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">zend_mm_low_bit</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> _size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__GNUC__<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">defined</span><span class="token punctuation">(</span>__native_client__<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>i386<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> n<span class="token punctuation">;</span>

	<span class="token function">__asm__</span><span class="token punctuation">(</span><span class="token string">&quot;bsfl %1,%0\\n\\t&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;=r&quot;</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;rm&quot;</span>  <span class="token punctuation">(</span>_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> n<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__GNUC__<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">defined</span><span class="token punctuation">(</span>__x86_64__<span class="token punctuation">)</span></span></span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> n<span class="token punctuation">;</span>

        <span class="token function">__asm__</span><span class="token punctuation">(</span><span class="token string">&quot;bsf %1,%0\\n\\t&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;=r&quot;</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;rm&quot;</span>  <span class="token punctuation">(</span>_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>n<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>_MSC_VER<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">defined</span><span class="token punctuation">(</span>_M_IX86<span class="token punctuation">)</span></span></span>
	__asm <span class="token punctuation">{</span>
		bsf eax<span class="token punctuation">,</span> _size
	<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
	<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> offset<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> n<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	n <span class="token operator">=</span> offset<span class="token punctuation">[</span>_size <span class="token operator">&amp;</span> <span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		_size <span class="token operator">&gt;&gt;=</span> <span class="token number">4</span><span class="token punctuation">;</span>
		index <span class="token operator">+=</span> n<span class="token punctuation">;</span>
		n <span class="token operator">=</span> offset<span class="token punctuation">[</span>_size <span class="token operator">&amp;</span> <span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> index <span class="token operator">+</span> n<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>看看汇编和后面的C语言实现的方式就懂了，即bit scan forward，从低位向高位扫描，返回遇到1的比特位数。比如：bitmap为52(00110100)，那么返回值为2。可以看出，ZEND_MM_BUCKET_INDEX和zend_mm_low_bit结合起来，才是free_buckets的hash映射函数。</p><p>zend_mm_high_bit则为large_free_buckets的hash映射函数。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ZEND_MM_LARGE_BUCKET_INDEX</span><span class="token expression"><span class="token punctuation">(</span>S<span class="token punctuation">)</span> <span class="token function">zend_mm_high_bit</span><span class="token punctuation">(</span>S<span class="token punctuation">)</span></span></span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">zend_mm_high_bit</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> _size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__GNUC__<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">defined</span><span class="token punctuation">(</span>__native_client__<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>i386<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> n<span class="token punctuation">;</span>

	<span class="token function">__asm__</span><span class="token punctuation">(</span><span class="token string">&quot;bsrl %1,%0\\n\\t&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;=r&quot;</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;rm&quot;</span>  <span class="token punctuation">(</span>_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> n<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__GNUC__<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">defined</span><span class="token punctuation">(</span>__x86_64__<span class="token punctuation">)</span></span></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> n<span class="token punctuation">;</span>

        <span class="token function">__asm__</span><span class="token punctuation">(</span><span class="token string">&quot;bsr %1,%0\\n\\t&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;=r&quot;</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;rm&quot;</span>  <span class="token punctuation">(</span>_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>n<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>_MSC_VER<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">defined</span><span class="token punctuation">(</span>_M_IX86<span class="token punctuation">)</span></span></span>
	__asm <span class="token punctuation">{</span>
		bsr eax<span class="token punctuation">,</span> _size
	<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>_size <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		_size <span class="token operator">=</span> _size <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
		n<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>zend_mm_high_bit是bit scan reverse，也是从低位向高位扫描，但它是返回遇到最高位1的比特位数。比如：bitmap为512(1000000000)，那么返回值为9。</p><p><strong>5.3：</strong> 成功分配内存并返回。</p><p><strong>6：</strong> 如果free_buckets没有找到合适的内存，则进入zend_mm_search_large_block，在large_free_buckets中寻找合适的内存。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>best_fit <span class="token operator">=</span> <span class="token function">zend_mm_search_large_block</span><span class="token punctuation">(</span>heap<span class="token punctuation">,</span> true_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>**6.1：**使用前面说过的宏ZEND_MM_LARGE_BUCKET_INDEX，来查找true_size对应的large_free_buckets。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token class-name">size_t</span> index <span class="token operator">=</span> <span class="token function">ZEND_MM_LARGE_BUCKET_INDEX</span><span class="token punctuation">(</span>true_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>**6.2：**和之前小块内存分配的逻辑一样，看看large_free_buckets中剩余的内存是否满足true_size。（将heap-&gt;free_bitmap 右移index次，不为0则有空闲内存）</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token class-name">size_t</span> bitmap <span class="token operator">=</span> heap<span class="token operator">-&gt;</span>large_free_bitmap <span class="token operator">&gt;&gt;</span> index<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>bitmap <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>**6.3：**看看large_free_buckets[index]是否存在可用的内存。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UNEXPECTED</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bitmap <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>large_free_buckets是一种字典树，如果large_free_buckets[index]中的内存大小和true_size相等，则返回这块内存。</p><p>如果没有找到大小相等的内存，则寻找最小的“大块内存”。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>best_fit <span class="token operator">=</span> p <span class="token operator">=</span> heap<span class="token operator">-&gt;</span>large_free_buckets<span class="token punctuation">[</span>index <span class="token operator">+</span> <span class="token function">zend_mm_low_bit</span><span class="token punctuation">(</span>bitmap<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>child<span class="token punctuation">[</span>p<span class="token operator">-&gt;</span>child<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ZEND_MM_FREE_BLOCK_SIZE</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token function">ZEND_MM_FREE_BLOCK_SIZE</span><span class="token punctuation">(</span>best_fit<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		best_fit <span class="token operator">=</span> p<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中，<code>p = p→child[p→child[0] != NULL]</code> ，是寻找最小的block。</p><p><strong>7：</strong> 如果free_bucket和large_free_buckets都没有找到合适的内存，那么只好去搜索rest_buckets了。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>best_fit <span class="token operator">&amp;&amp;</span> heap<span class="token operator">-&gt;</span>real_size <span class="token operator">&gt;=</span> heap<span class="token operator">-&gt;</span>limit <span class="token operator">-</span> heap<span class="token operator">-&gt;</span>block_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	zend_mm_free_block <span class="token operator">*</span>p <span class="token operator">=</span> heap<span class="token operator">-&gt;</span>rest_buckets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token class-name">size_t</span> best_size <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>**8：**如果以上都没有合适的内存的话（有可能是初始化的时候，或者内存不足的情况），申请一块段内存。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>segment <span class="token operator">=</span> <span class="token punctuation">(</span>zend_mm_segment <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">ZEND_MM_STORAGE_ALLOC</span><span class="token punctuation">(</span>segment_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>然后将这块新segment的第一块block作为best_fit使用。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>best_fit <span class="token operator">=</span> <span class="token punctuation">(</span>zend_mm_free_block <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> segment <span class="token operator">+</span> ZEND_MM_ALIGNED_SEGMENT_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">ZEND_MM_MARK_FIRST_BLOCK</span><span class="token punctuation">(</span>best_fit<span class="token punctuation">)</span><span class="token punctuation">;</span>
block_size <span class="token operator">=</span> segment_size <span class="token operator">-</span> ZEND_MM_ALIGNED_SEGMENT_SIZE <span class="token operator">-</span> ZEND_MM_ALIGNED_HEADER_SIZE<span class="token punctuation">;</span>
<span class="token function">ZEND_MM_LAST_BLOCK</span><span class="token punctuation">(</span><span class="token function">ZEND_MM_BLOCK_AT</span><span class="token punctuation">(</span>best_fit<span class="token punctuation">,</span> block_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>segment的结构如下图：</p><figure><img src="https://cdn.jsdelivr.net/gh/MarsAuthority/sec_pic@master/uPic/2023-02/0LGJRs.jpg" alt="0LGJRs" tabindex="0" loading="lazy"><figcaption>0LGJRs</figcaption></figure><p>**9：**最后，将新的block放入large_free_buckets/free_buckets/rest_buckets。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>zend_mm_free_block <span class="token operator">*</span>new_free_block<span class="token punctuation">;</span>

<span class="token comment">/* prepare new free block */</span>
<span class="token function">ZEND_MM_BLOCK</span><span class="token punctuation">(</span>best_fit<span class="token punctuation">,</span> ZEND_MM_USED_BLOCK<span class="token punctuation">,</span> true_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
new_free_block <span class="token operator">=</span> <span class="token punctuation">(</span>zend_mm_free_block <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">ZEND_MM_BLOCK_AT</span><span class="token punctuation">(</span>best_fit<span class="token punctuation">,</span> true_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">ZEND_MM_BLOCK</span><span class="token punctuation">(</span>new_free_block<span class="token punctuation">,</span> ZEND_MM_FREE_BLOCK<span class="token punctuation">,</span> remaining_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* add the new free block to the free list */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">EXPECTED</span><span class="token punctuation">(</span><span class="token operator">!</span>keep_rest<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">zend_mm_add_to_free_list</span><span class="token punctuation">(</span>heap<span class="token punctuation">,</span> new_free_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
	<span class="token function">zend_mm_add_to_rest_list</span><span class="token punctuation">(</span>heap<span class="token punctuation">,</span> new_free_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过zend_mm_add_to_free_list可以看到large_free_bucket和free_buckets的分配方式。如果new_free_block是大块内存，则将它分配到large_free_buckets。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>index <span class="token operator">=</span> <span class="token function">ZEND_MM_LARGE_BUCKET_INDEX</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//通过ZEND_MM_LARGE_BUCKET_INDEX定位到size对应的index</span>
p <span class="token operator">=</span> <span class="token operator">&amp;</span>heap<span class="token operator">-&gt;</span>large_free_buckets<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
mm_block<span class="token operator">-&gt;</span>child<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> mm_block<span class="token operator">-&gt;</span>child<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> 
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果large_free_buckets[index]不存在，则直接写入。</span>
	<span class="token operator">*</span>p <span class="token operator">=</span> mm_block<span class="token punctuation">;</span>
	mm_block<span class="token operator">-&gt;</span>parent <span class="token operator">=</span> p<span class="token punctuation">;</span>
	mm_block<span class="token operator">-&gt;</span>prev_free_block <span class="token operator">=</span> mm_block<span class="token operator">-&gt;</span>next_free_block <span class="token operator">=</span> mm_block<span class="token punctuation">;</span>
	heap<span class="token operator">-&gt;</span>large_free_bitmap <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">ZEND_MM_LONG_CONST</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//large_free_bitmap为可用大块内存大小</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
	<span class="token class-name">size_t</span> m<span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> size <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>ZEND_MM_NUM_BUCKETS <span class="token operator">-</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> m <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		zend_mm_free_block <span class="token operator">*</span>prev <span class="token operator">=</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ZEND_MM_FREE_BLOCK_SIZE</span><span class="token punctuation">(</span>prev<span class="token punctuation">)</span> <span class="token operator">!=</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//block的大小和size的大小不一样时，存入使其成为best_fit</span>
			p <span class="token operator">=</span> <span class="token operator">&amp;</span>prev<span class="token operator">-&gt;</span>child<span class="token punctuation">[</span><span class="token punctuation">(</span>m <span class="token operator">&gt;&gt;</span> <span class="token punctuation">(</span>ZEND_MM_NUM_BUCKETS<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//这里的m是size先左移(ZEND_MM_NUM_BUCKETS - index)，后(ZEND_MM_NUM_BUCKETS-1))，说白了就是将size右移至剩余的高两位。 比如size为1024，则这里(m &gt;&gt; (ZEND_MM_NUM_BUCKETS-1))的结果是10 。如果最后一位为0，则将mm_block放入child[0]，最后一位是1，mm_block放入child[1]。相应地，在zend_mm_search_large_block中，使用m = true_size &lt;&lt; (ZEND_MM_NUM_BUCKETS - index)，将size左移(32-size位数)位，最高位0，则取child[0]，最高位1，则取child[1]。</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token operator">*</span>p <span class="token operator">=</span> mm_block<span class="token punctuation">;</span>
				mm_block<span class="token operator">-&gt;</span>parent <span class="token operator">=</span> p<span class="token punctuation">;</span>
				mm_block<span class="token operator">-&gt;</span>prev_free_block <span class="token operator">=</span> mm_block<span class="token operator">-&gt;</span>next_free_block <span class="token operator">=</span> mm_block<span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//block的大小和size的大小一样时，之前存入zend_mm_block中，本质是一个双向链表。</span>
			zend_mm_free_block <span class="token operator">*</span>next <span class="token operator">=</span> prev<span class="token operator">-&gt;</span>next_free_block<span class="token punctuation">;</span>

			prev<span class="token operator">-&gt;</span>next_free_block <span class="token operator">=</span> next<span class="token operator">-&gt;</span>prev_free_block <span class="token operator">=</span> mm_block<span class="token punctuation">;</span>
			mm_block<span class="token operator">-&gt;</span>next_free_block <span class="token operator">=</span> next<span class="token punctuation">;</span>
			mm_block<span class="token operator">-&gt;</span>prev_free_block <span class="token operator">=</span> prev<span class="token punctuation">;</span>
			mm_block<span class="token operator">-&gt;</span>parent <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>large_free_buckets的结构如下图：</p><figure><img src="https://cdn.jsdelivr.net/gh/MarsAuthority/sec_pic@master/uPic/2023-02/cE8Ivb.jpg" alt="cE8Ivb" tabindex="0" loading="lazy"><figcaption>cE8Ivb</figcaption></figure><p>下面，说说ZendMM在释放内存的过程，跟分配内存的过程相反：</p><p><strong>1：</strong> 如果p是一个合法的指针，计算其对应的block，和block的大小。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ZEND_MM_VALID_PTR</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">HANDLE_BLOCK_INTERRUPTIONS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

mm_block <span class="token operator">=</span> <span class="token function">ZEND_MM_HEADER_OF</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
size <span class="token operator">=</span> <span class="token function">ZEND_MM_BLOCK_SIZE</span><span class="token punctuation">(</span>mm_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">ZEND_MM_CHECK_PROTECTION</span><span class="token punctuation">(</span>mm_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>**2：**如果size是小块内存且cache未满(最大ZEND_MM_CACHE_SIZE)，计算其对应的index，将mm_block放入cache[index]。（CACHE默认开启，其中ZEND_MM_SMALL_SIZE、ZEND_MM_BUCKET_INDEX在前面分配内存的时候讲过）</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ZEND_MM_CACHE</span></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">EXPECTED</span><span class="token punctuation">(</span><span class="token function">ZEND_MM_SMALL_SIZE</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">EXPECTED</span><span class="token punctuation">(</span>heap<span class="token operator">-&gt;</span>cached <span class="token operator">&lt;</span> ZEND_MM_CACHE_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">size_t</span> index <span class="token operator">=</span> <span class="token function">ZEND_MM_BUCKET_INDEX</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span> 
		zend_mm_free_block <span class="token operator">*</span><span class="token operator">*</span>cache <span class="token operator">=</span> <span class="token operator">&amp;</span>heap<span class="token operator">-&gt;</span>cache<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>

		<span class="token punctuation">(</span><span class="token punctuation">(</span>zend_mm_free_block<span class="token operator">*</span><span class="token punctuation">)</span>mm_block<span class="token punctuation">)</span><span class="token operator">-&gt;</span>prev_free_block <span class="token operator">=</span> <span class="token operator">*</span>cache<span class="token punctuation">;</span>
		<span class="token operator">*</span>cache <span class="token operator">=</span> <span class="token punctuation">(</span>zend_mm_free_block<span class="token operator">*</span><span class="token punctuation">)</span>mm_block<span class="token punctuation">;</span>
		heap<span class="token operator">-&gt;</span>cached <span class="token operator">+=</span> size<span class="token punctuation">;</span>
		<span class="token function">ZEND_MM_SET_MAGIC</span><span class="token punctuation">(</span>mm_block<span class="token punctuation">,</span> MEM_BLOCK_CACHED<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ZEND_MM_CACHE_STAT</span></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>heap<span class="token operator">-&gt;</span>cache_stat<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>count <span class="token operator">&gt;</span> heap<span class="token operator">-&gt;</span>cache_stat<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>max_count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			heap<span class="token operator">-&gt;</span>cache_stat<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>max_count <span class="token operator">=</span> heap<span class="token operator">-&gt;</span>cache_stat<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>count<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>**3：**如果size是大块内存或者cache已满，且mm_block的前一块或者后一块block是空闲块，则调用zend_mm_remove_from_free_list将其删除（将下一个节点/上一节点合并）。如果mm_block为segment的第一块，则使用zend_mm_del_segment删除这个segment。否则就使用zend_mm_add_to_free_list将mm_block加入large_free_buckets/free_buckets/rest_buckets。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>next_block <span class="token operator">=</span> <span class="token function">ZEND_MM_BLOCK_AT</span><span class="token punctuation">(</span>mm_block<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ZEND_MM_IS_FREE_BLOCK</span><span class="token punctuation">(</span>next_block<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">zend_mm_remove_from_free_list</span><span class="token punctuation">(</span>heap<span class="token punctuation">,</span> <span class="token punctuation">(</span>zend_mm_free_block <span class="token operator">*</span><span class="token punctuation">)</span> next_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
	size <span class="token operator">+=</span> <span class="token function">ZEND_MM_FREE_BLOCK_SIZE</span><span class="token punctuation">(</span>next_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ZEND_MM_PREV_BLOCK_IS_FREE</span><span class="token punctuation">(</span>mm_block<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	mm_block <span class="token operator">=</span> <span class="token function">ZEND_MM_PREV_BLOCK</span><span class="token punctuation">(</span>mm_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">zend_mm_remove_from_free_list</span><span class="token punctuation">(</span>heap<span class="token punctuation">,</span> <span class="token punctuation">(</span>zend_mm_free_block <span class="token operator">*</span><span class="token punctuation">)</span> mm_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
	size <span class="token operator">+=</span> <span class="token function">ZEND_MM_FREE_BLOCK_SIZE</span><span class="token punctuation">(</span>mm_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ZEND_MM_IS_FIRST_BLOCK</span><span class="token punctuation">(</span>mm_block<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token function">ZEND_MM_IS_GUARD_BLOCK</span><span class="token punctuation">(</span><span class="token function">ZEND_MM_BLOCK_AT</span><span class="token punctuation">(</span>mm_block<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">zend_mm_del_segment</span><span class="token punctuation">(</span>heap<span class="token punctuation">,</span> <span class="token punctuation">(</span>zend_mm_segment <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>mm_block <span class="token operator">-</span> ZEND_MM_ALIGNED_SEGMENT_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
	<span class="token function">ZEND_MM_BLOCK</span><span class="token punctuation">(</span>mm_block<span class="token punctuation">,</span> ZEND_MM_FREE_BLOCK<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">zend_mm_add_to_free_list</span><span class="token punctuation">(</span>heap<span class="token punctuation">,</span> <span class="token punctuation">(</span>zend_mm_free_block <span class="token operator">*</span><span class="token punctuation">)</span> mm_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中zend_mm_remove_from_free_list也只是将large_free_buckets/free_buckets/rest_buckets中mm_block的相关指针销毁，将回收到内存池中。</p><h2 id="小结" tabindex="-1"><a class="header-anchor" href="#小结" aria-hidden="true">#</a> 小结</h2><p>PHP的内存管理实现了自己的内存池，使得PHP内核在真正使用内存之前，先申请一块内存，当我们申请内存时就从内存池中分出一部分内存块，若内存块不够再继续申请新的内存，提高了内存分配的效率。PHP还实现了垃圾回收机制（Garbage Collection）及写时复制（Copy On Write）以进一步优化。</p><p>以上文章仅仅是我个人(当然主要还是那些参考资料)的理解，有什么错误的地方还请指正。</p><h2 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料" aria-hidden="true">#</a> 参考资料</h2>`,114),r={href:"http://www.kancloud.cn/kancloud/php-internals/42794",target:"_blank",rel:"noopener noreferrer"},k={href:"https://wiki.php.net/internals/zend_mm",target:"_blank",rel:"noopener noreferrer"},d={href:"http://www.phppan.com/php-source-analytics/",target:"_blank",rel:"noopener noreferrer"},m={href:"http://www.laruence.com/2011/11/09/2277.html",target:"_blank",rel:"noopener noreferrer"},_={href:"https://github.com/php/php-src/blob/PHP-5.4/Zend/zend_alloc.c",target:"_blank",rel:"noopener noreferrer"};function v(b,f){const s=l("ExternalLinkIcon");return e(),o("div",null,[u,n("ol",null,[n("li",null,[n("a",r,[a("http://www.kancloud.cn/kancloud/php-internals/42794"),t(s)])]),n("li",null,[n("a",k,[a("https://wiki.php.net/internals/zend_mm"),t(s)])]),n("li",null,[n("a",d,[a("http://www.phppan.com/php-source-analytics/"),t(s)])]),n("li",null,[n("a",m,[a("http://www.laruence.com/2011/11/09/2277.html"),t(s)])]),n("li",null,[n("a",_,[a("https://github.com/php/php-src/blob/PHP-5.4/Zend/zend_alloc.c"),t(s)])])])])}const h=p(i,[["render",v],["__file","理解PHP内存管理.html.vue"]]);export{h as default};
